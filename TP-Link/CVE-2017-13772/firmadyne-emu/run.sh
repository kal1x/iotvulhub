#!/bin/bash

# 启动 ssh 服务
/etc/init.d/ssh start

cd ./firmadyne

FILE="`ls -ld /root/firmware/* | grep -v "^d" | rev | cut -d " " -f 1 | rev`"
FNAME=$(basename "${FILE}")
FNAME="${FNAME%.*}"

# 固件解包
echo 'Extracting the firmware...'
./extractor/extractor.py -nk "${FILE}" images

# 检查 fs 文件是否存在
if [ ! -f ./images/1.tar.gz ]; then
    echo "File ./images/1.tar.gz not found, probably an extraction problem happened"
    exit 1
fi

# 获取体系结构
echo 'Getting the architecture...'
ARCH=$(./scripts/getArch.sh ./images/1.tar.gz | cut -d ' ' -f2)

# 创建镜像并获取网络信息
echo 'Creating the image...'
./scripts/makeImage.sh 1 ${ARCH}
./scripts/inferNetwork.sh 1 ${ARCH}

# 启动模拟
echo 'Start running...'
./scratch/1/run.sh

cd ..
